x-build-config: &build_config
  context: .
  target: dev
  args:
    - USER=${USER}
    - UID=${UID}
    - GID=${GID}

services:
  drugslm:
    build: *build_config
    image: drugslm:${VERSION}
    pull_policy: build
    container_name: drugslm
    profiles: ["dev","all"]
    volumes:
      - ./:/workspace
    command: make sleep
    tty: true
    stdin_open: true

  dagster:
    build: *build_config
    image: drugslm:${VERSION}
    pull_policy: build
    container_name: drugslm_dagster
    profiles: ["pipeline","all"]
    volumes:
      - ./:/workspace
    ports:
      - "3000:3000"
    command: make dagster up
    environment: 
      - DAGSTER_HOME=/workspace
    tty: true
    stdin_open: true
    restart: unless-stopped

  mkdocs:
    build: *build_config
    image: drugslm:${VERSION}
    pull_policy: build
    container_name: drugslm_docs
    profiles: ["docs","all"]
    volumes:
      - ./:/workspace
    ports:
      - "8000:8000"
    command: make docs watch
    tty: true
    stdin_open: true
    restart: unless-stopped

  mkdocs-funnel:
    image: tailscale/tailscale:latest
    container_name: drugslm_docs_funnel
    profiles: ["funnel","all"]
    network_mode: service:mkdocs
    depends_on:
      - mkdocs
    env_file:
      - .secrets/tailscale.env
    volumes:
      - /dev/net/tun:/dev/net/tun
      - .tailscale/mkdocs:/var/lib/tailscale
      - .tailscale/mkdocs-funnel.json:/config/server.json:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped

# TODO: Recolocar servi√ßos aqui como o Selenium, mas usando o profiles: [scraper]
